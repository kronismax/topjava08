Index: src/test/java/ru/javawebinar/topjava/SpringMain.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- src/test/java/ru/javawebinar/topjava/SpringMain.java	(revision 4eec8154549fcbf660cc6998ce877e26e9bb74d2)
+++ src/test/java/ru/javawebinar/topjava/SpringMain.java	(revision )
@@ -11,6 +11,9 @@
 import java.util.Arrays;
 import java.util.List;
 
+import static ru.javawebinar.topjava.TestUtil.mockAuthorize;
+import static ru.javawebinar.topjava.UserTestData.USER;
+
 /**
  * User: gkislin
  * Date: 22.08.2014
@@ -23,9 +26,11 @@
             appCtx.load("spring/spring-app.xml", "spring/spring-db.xml", "spring/spring-mvc.xml");
             appCtx.refresh();
 
+            mockAuthorize(USER);
+
             System.out.println("Bean definition names: " + Arrays.toString(appCtx.getBeanDefinitionNames()));
             AdminRestController adminUserController = appCtx.getBean(AdminRestController.class);
-            adminUserController.create(UserTestData.USER);
+            adminUserController.get(UserTestData.USER_ID);
             System.out.println();
 
             MealRestController mealController = appCtx.getBean(MealRestController.class);
Index: src/test/java/ru/javawebinar/topjava/web/RootControllerTest.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- src/test/java/ru/javawebinar/topjava/web/RootControllerTest.java	(revision 4eec8154549fcbf660cc6998ce877e26e9bb74d2)
+++ src/test/java/ru/javawebinar/topjava/web/RootControllerTest.java	(revision )
@@ -1,12 +1,11 @@
-package ru.javawebinar.topjava.web.user;
+package ru.javawebinar.topjava.web;
 
 import org.junit.Test;
-import ru.javawebinar.topjava.web.AbstractControllerTest;
 
 import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
 import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
 import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;
-import static ru.javawebinar.topjava.TestUtil.authorize;
+import static ru.javawebinar.topjava.TestUtil.userAuth;
 import static ru.javawebinar.topjava.UserTestData.ADMIN;
 import static ru.javawebinar.topjava.UserTestData.USER;
 
@@ -14,12 +13,13 @@
  * GKislin
  * 10.04.2015.
  */
+
 public class RootControllerTest extends AbstractControllerTest {
 
     @Test
     public void testUsers() throws Exception {
-        authorize(ADMIN);
-        mockMvc.perform(get("/users"))
+        mockMvc.perform(get("/users")
+                .with(userAuth(ADMIN)))
                 .andDo(print())
                 .andExpect(status().isOk())
                 .andExpect(view().name("users"))
@@ -36,8 +36,8 @@
 
     @Test
     public void testMeals() throws Exception {
-        authorize(USER);
-        mockMvc.perform(get("/meals"))
+        mockMvc.perform(get("/meals")
+                .with(userAuth(USER)))
                 .andDo(print())
                 .andExpect(view().name("meals"))
                 .andExpect(forwardedUrl("/WEB-INF/jsp/meals.jsp"));
\ No newline at end of file
Index: src/test/java/ru/javawebinar/topjava/TestUtil.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- src/test/java/ru/javawebinar/topjava/TestUtil.java	(revision 4eec8154549fcbf660cc6998ce877e26e9bb74d2)
+++ src/test/java/ru/javawebinar/topjava/TestUtil.java	(revision )
@@ -24,12 +24,16 @@
         return action.andReturn().getResponse().getContentAsString();
     }
 
-    public static void authorize(User user) {
+    public static void mockAuthorize(User user) {
         SecurityContextHolder.getContext().setAuthentication(
-                new UsernamePasswordAuthenticationToken(user.getEmail(), user.getPassword()));
+                new UsernamePasswordAuthenticationToken(new AuthorizedUser(user), null, user.getRoles()));
     }
 
     public static RequestPostProcessor userHttpBasic(User user) {
         return SecurityMockMvcRequestPostProcessors.httpBasic(user.getEmail(), user.getPassword());
+    }
+
+    public static RequestPostProcessor userAuth(User user) {
+        return SecurityMockMvcRequestPostProcessors.authentication(new UsernamePasswordAuthenticationToken(user.getEmail(), user.getPassword()));
     }
 }
Index: src/main/resources/db/populateDB.sql
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- src/main/resources/db/populateDB.sql	(revision 4eec8154549fcbf660cc6998ce877e26e9bb74d2)
+++ src/main/resources/db/populateDB.sql	(revision )
@@ -1,5 +1,13 @@
 -- http://stackoverflow.com/questions/13223820/postgresql-delete-all-content
-TRUNCATE users CASCADE;
+-- TRUNCATE public CASCADE;
+
+-- http://stackoverflow.com/a/4991969/548473
+-- TRUNCATE SCHEMA public AND COMMIT;
+
+DELETE FROM user_roles;
+DELETE FROM meals;
+DELETE FROM users;
+
 ALTER SEQUENCE global_seq RESTART WITH 100000;
 
 INSERT INTO users (name, email, password)
